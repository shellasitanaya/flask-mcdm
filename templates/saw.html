{% extends 'base.html' %}
{% block title %}SAW Method - MCDM App{% endblock %}

{% block content %}

<style>
  .no-scroll {
      overflow: hidden !important; /* !important to override potential other styles */
      padding-right: var(--scrollbar-width, 0); /* To prevent content shift if scrollbar disappears */
  }


  th {
    text-align: start;
  }

  th, td {
    border: 2px solid gray;
    padding: 5px 15px 5px 5px;
  }
</style>

<section class="max-w-6xl mx-auto p-6">
  <div class="flex items-center mb-6">
    <h2 class="text-3xl font-bold">SAW Method</h2>
    <button onclick="toggleDirectionModal()" class="ml-2 rounded-full border-2 border-blue-500 text-blue-500 hover:text-white hover:bg-blue-500 transition-colors font-bold !h-[25px] !w-[25px] flex justify-center items-center">?</button>
  </div>

  <div class="mb-8">
    <form id="uploadExcelForm" method="post" enctype="multipart/form-data" class="mb-6 flex-col flex">
      <label class="block font-semibold mb-2">Upload XLSX/CSV file (optional):</label>
      <input type="file" name="excel_file" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="mb-3">
      <div class="flex items-center">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition w-fit h-fit mr-1">â‡ª Upload</button>
        <a href="{{ url_for('download_template', template_name='SAW') }}" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-700 transition font-semibold w-fit h-fit ">ðŸ“„ Download Template</a>
      </div>
    </form>
  </div>

  <form method="post" id="sawForm" class="mb-10">
    <table class="w-full table-auto border-collapse border border-gray-300 mb-6" id="sawTable">
      <thead>
        <tr class="bg-blue-100">
          <th class="border border-gray-300 px-3 py-2">Alternatif</th>
          {% for c in criteria %}
          <th class="border border-gray-300 px-3 py-2">{{ c.nama }}<br><small>({{ c.tipe }})</small></th>
          {% endfor %}
          <th class="border border-gray-300 px-3 py-2">Aksi</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr>
          <td class="border border-gray-300 px-2 py-1 text-center">
            <input type="text" name="alt_name_0" class="w-full text-center border rounded px-1 py-1">
          </td>
          {% for j in range(criteria|length) %}
          <td class="border border-gray-300 px-2 py-1 text-center">
            <input type="number" step="any" min="0" name="value_0_{{j}}"
              class="w-full text-center border rounded px-1 py-1" required>
          </td>
          {% endfor %}
          <td class="border border-gray-300 px-2 py-1 text-center">
            <button type="button" class="remove-row text-red-600 font-semibold">Delete</button>
          </td>
        </tr>
      </tbody>
    </table>

    <button type="button" id="addRowBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">+
      Add Row</button>
    <input type="hidden" name="alt_count" id="altCount" value="1">

    <button type="submit"
      class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-700 transition font-semibold mt-4">Calculate
      SAW</button>
  </form>

  {% if ranked %}
  <section>
    <h3 class="text-2xl font-bold mb-4">Ranking Results</h3>
    <table class="w-full table-auto border-collapse border border-gray-300">
      <thead>
        <tr class="bg-blue-200">
          <th class="border border-gray-300 px-3 py-2">Rank</th>
          <th class="border border-gray-300 px-3 py-2">Alternatif</th>
          <th class="border border-gray-300 px-3 py-2">Score (Vi)</th>
        </tr>
      </thead>
      <tbody>
        {% for alt, score in ranked %}
        <tr>
          <td class="border border-gray-300 px-3 py-2 text-center">{{ loop.index }}</td>
          <td class="border border-gray-300 px-3 py-2">{{ alt }}</td>
          <td class="border border-gray-300 px-3 py-2 text-center">{{ '%.4f'|format(score) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
  {% endif %}


  {% if matrix and normalized_matrix and weighted_matrix and scores %}
<hr class="my-10 border-t border-gray-400">

<section class="mt-10">
  <h3 class="text-2xl font-bold mb-4">Langkah-langkah Perhitungan SAW</h3>

  <!-- Matriks Keputusan -->
  <h4 class="text-xl font-semibold mt-6 mb-2">1. Matriks Keputusan</h4>
  <table class="w-full border mb-6">
    <thead class="bg-blue-200 ">
      <tr>
        <th class="border px-2 py-1">Alternatif</th>
        {% for c in criteria %}
        <th class="border px-2 py-1">{{ c.nama }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for i in range(alternatives|length) %}
      <tr>
        <td class="border px-2 py-1">{{ alternatives[i] }}</td>
        {% for j in range(criteria|length) %}
        <td class="border px-2 py-1 text-center">{{ matrix[i][j] }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Normalisasi -->
  <h4 class="text-xl font-semibold mt-6 mb-2">2. Matriks Ternormalisasi</h4>
  <table class="w-full border mb-6">
    <thead class="bg-blue-200 ">
      <tr>
        <th class="border px-2 py-1">Alternatif</th>
        {% for c in criteria %}
        <th class="border px-2 py-1">{{ c.nama }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for i in range(alternatives|length) %}
      <tr>
        <td class="border px-2 py-1">{{ alternatives[i] }}</td>
        {% for j in range(criteria|length) %}
        <td class="border px-2 py-1 text-center">{{ '%.4f'|format(normalized_matrix[i][j]) }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Bobot x Normalisasi -->
  <h4 class="text-xl font-semibold mt-6 mb-2">3. Normalisasi x Bobot</h4>
  <table class="w-full border mb-6">
    <thead class="bg-blue-200 ">
      <tr>
        <th class="border px-2 py-1">Alternatif</th>
        {% for c in criteria %}
        <th class="border px-2 py-1">{{ c.nama }}<br><small>x {{ c.bobot }}</small></th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for i in range(alternatives|length) %}
      <tr>
        <td class="border px-2 py-1">{{ alternatives[i] }}</td>
        {% for j in range(criteria|length) %}
        <td class="border px-2 py-1 text-center">{{ '%.4f'|format(weighted_matrix[i][j]) }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Nilai Akhir -->
  <h4 class="text-xl font-semibold mt-6 mb-2">4. Nilai Akhir (V<sub>i</sub>)</h4>
  <table class="w-full border mb-6">
    <thead class="bg-blue-200 ">
      <tr>
        <th class="border px-2 py-1">Alternatif</th>
        <th class="border px-2 py-1">Skor Akhir (V<sub>i</sub>)</th>
      </tr>
    </thead>
    <tbody>
      {% for i in range(alternatives|length) %}
      <tr>
        <td class="border px-2 py-1">{{ alternatives[i] }}</td>
        <td class="border px-2 py-1 text-center">{{ '%.4f'|format(scores[i]) }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
{% endif %}

</section>

<input type="hidden" id="criteria-count" value="{{ criteria|length|default(0)|int }}">

<!-- modal -->
<div id="instruction-modal" class="w-screen h-screen fixed top-0 left-0 bg-black/50 flex justify-center items-center px-8">
  

  <div class="rounded-2xl border-2 border-slate-300 bg-white w-full max-h-[500px] mt-[50px] relative flex flex-col justify-center items-center pt-1 pb-6 px-6">
    <div class="w-full flex"><button onclick="toggleDirectionModal()" class="text-5xl ml-auto">Ã—</button></div>

    <h2 class="mt-1 mb-4 font-bold lg:text-3xl">Instruction</h2>

    <div class="w-full grow overflow-scroll">
      <table class=" mt-4 w-full">
        

        
        <tr class="bg-blue-100">
          <th>Criteria</th>
          <th>Type</th>
          <th>Description</th>
        </tr>

        
          {% for c in criteria %}
        <tr>
          <td>{{ c.nama }}</td>
          <td>{{ c.tipe }}</td>
          <td>{{ c.description | safe }}</td>
        </tr>
          {% endfor %}
        

      </table>
    </div>

  </div>
</div>




<script>
  let rowCount = 1;
  const altCountInput = document.getElementById('altCount');
  const uploadExcelForm = document.getElementById('uploadExcelForm');

  function updateAltCount() {
    const rowElements = document.querySelectorAll('#tableBody tr');
    altCountInput.value = rowElements.length;
  }

  document.getElementById('addRowBtn').addEventListener('click', function () {
    const tbody = document.getElementById('tableBody');
    const criteriaCount = parseInt(document.getElementById('criteria-count').value);

    const row = document.createElement('tr');

    let rowHTML = `
      <td class="border border-gray-300 px-2 py-1 text-center">
        <input type="text" name="alt_name_${rowCount}" class="w-full text-center border rounded px-1 py-1">
      </td>`;
    for (let j = 0; j < criteriaCount; j++) {
      rowHTML += `
      <td class="border border-gray-300 px-2 py-1 text-center">
        <input type="number" step="any" min="0" name="value_${rowCount}_${j}" class="w-full text-center border rounded px-1 py-1" required>
      </td>`;
    }
    rowHTML += `
      <td class="border border-gray-300 px-2 py-1 text-center">
        <button type="button" class="remove-row text-red-600 font-semibold">Delete</button>
      </td>`;

    row.innerHTML = rowHTML;
    tbody.appendChild(row);
    rowCount++;
    updateAltCount();
  });

  document.getElementById('tableBody').addEventListener('click', function (e) {
    if (e.target.classList.contains('remove-row')) {
      const row = e.target.closest('tr');
      row.remove();
      updateAltCount();
    }
  });

  updateAltCount();



  uploadExcelForm.addEventListener('submit', async function (e) {
    e.preventDefault(); // Prevent default form submission

    const formData = new FormData(this); // 'this' refers to the form element

    // Get the file input itself
    const fileInput = this.querySelector('input[type="file"]');
    if (fileInput.files.length === 0) {
      Swal.fire({
        title: "Error",
        text: "No file selected.",
        icon: "error"
      });

      return;
    }


    try {
      Swal.fire({
        title: "Continue?",
        showCancelButton: true,
        confirmButtonText: "Continue",
        text: "All data in table will be replaced with your excel file data.",
        icon: "question"
      }).then(async (result) => {

        if (result.isConfirmed) {
          
          const response = await fetch('/read-excel', { // Send to your Flask route
            method: 'POST',
            body: formData, // FormData handles 'multipart/form-data' correctly
          });

          const resultt = await response.json(); // Parse JSON response

          if (response.ok) {
            // console.log(resultt);

            const tbody = document.getElementById('tableBody');
            const criteriaCount = parseInt(document.getElementById('criteria-count').value);


            // empty out entries
            tbody.innerHTML=``;
            rowCount = 0;

            resultt.forEach(alternative => {
              const row = document.createElement('tr');

              let rowHTML = `
                <td class="border border-gray-300 px-2 py-1 text-center">
                  <input type="text" name="alt_name_${rowCount}" class="w-full text-center border rounded px-1 py-1" value="${alternative[0]}">
                </td>`;
              for (let j = 0; j < criteriaCount; j++) {
                rowHTML += `
                <td class="border border-gray-300 px-2 py-1 text-center">
                  <input type="number" step="any" min="0" name="value_${rowCount}_${j}" class="w-full text-center border rounded px-1 py-1" required value="${alternative[j+1]}">
                </td>`;
              }
              rowHTML += `
                <td class="border border-gray-300 px-2 py-1 text-center">
                  <button type="button" class="remove-row text-red-600 font-semibold">Delete</button>
                </td>`;

              row.innerHTML = rowHTML;
              tbody.appendChild(row);
              rowCount++;
              updateAltCount();
            });
              
              

              

          } else {
            
            Swal.fire({
              title: "Error",
              text: "Failed in reading file.",
              icon: "error"
            });
            
          }
        } 
      });
    } catch (error) {
      console.error('Network or parsing error:', error);
      uploadMessageDiv.innerHTML = `<span class="text-red-600">An unexpected client-side error occurred: ${error.message}</span>`;
      if (rowCount === 0) addRow(); // Ensure at least one row exists for manual input
    }
  });

  const instructionModal = document.getElementById('instruction-modal');
  function toggleDirectionModal() {
    document.body.classList.toggle('no-scroll');
    instructionModal.classList.toggle('hidden');
  }

</script>


{% endblock %}