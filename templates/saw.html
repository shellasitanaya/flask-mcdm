{% extends 'base.html' %}
{% block title %}SAW Method - MCDM App{% endblock %}

{% block content %}

<style>
  .no-scroll {
      overflow: hidden !important; /* !important to override potential other styles */
      padding-right: var(--scrollbar-width, 0); /* To prevent content shift if scrollbar disappears */
  }


  th {
    text-align: start;
  }

  th, td {
    border: 2px solid gray;
    padding: 5px 15px 5px 5px;
  }
</style>

<!-- padding for smaller screen -->
<section class="max-w-6xl mx-auto p-4 sm:p-6">
  <div class="flex items-center mb-6">
    <h2 class="text-3xl font-bold text-gray-800">SAW Method</h2>
    <button onclick="toggleDirectionModal()" class="ml-2 rounded-full border-2 border-blue-500 text-blue-500 hover:text-white hover:bg-blue-500 transition-colors font-bold !h-[25px] !w-[25px] flex justify-center items-center">?</button>
  </div>

  <div class="mb-8 p-4 bg-white rounded-lg shadow-md">
    <form id="uploadExcelForm" method="post" enctype="multipart/form-data" class="mb-6 flex-col flex">
      <label class="block font-semibold mb-2">Upload XLSX/CSV file (optional):</label>
      <input type="file" name="excel_file" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="mb-3">
      <div class="flex items-center">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition w-fit h-fit mr-1">â‡ª Upload</button>
        <a href="{{ url_for('download_template', template_name='SAW') }}" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-700 transition font-semibold w-fit h-fit ">ðŸ“„ Download Template</a>
      </div>
    </form>
  </div>

  <!-- MANUAL INPUT -->
  <form method="post" id="criteriaForm" class="w-full mb-10 p-4 bg-white rounded-lg shadow-md"> 
    <input type="hidden" name="form_type" value="criteria">
    <input type="hidden" name="criteria_count_input" id="criteriaCountInput" value="{{ criteria|length }}">

    <h2 class="text-xl font-semibold mb-3 text-gray-800">Kriteria Penilaian</h2>

    <div class="overflow-x-auto rounded-lg border border-gray-300">
      <table class="min-w-full table-auto border-collapse"> 
        <thead>
          <tr class="bg-blue-100 text-gray-800">
            <th class="border border-gray-300 px-3 py-2 text-left text-sm sm:text-base">Nama Kriteria</th>
            <th class="border border-gray-300 px-3 py-2 text-left text-sm sm:text-base">Bobot</th>
            <th class="border border-gray-300 px-3 py-2 text-left text-sm sm:text-base">Tipe</th>
            <th class="border border-gray-300 px-3 py-2 text-center text-sm sm:text-base">Aksi</th>
          </tr>
        </thead>

        <tbody id="criteriaList">
          {% for c in criteria %}
          {% set i = loop.index0 %}
          <tr>
            <td class="border border-gray-300 px-2 py-1">
              <input type="text" name="criteria_name_{{i}}"
                class="w-full border border-gray-300 rounded px-2 py-1 text-sm sm:text-base focus:ring-blue-500 focus:border-blue-500"
                value="{{ c.nama }}" required>
            </td>
            <td class="border border-gray-300 px-2 py-1">
              <input type="number" name="criteria_weight_{{i}}" step="0.01" min="0" max="1"
                class="w-full border border-gray-300 rounded px-2 py-1 text-sm sm:text-base focus:ring-blue-500 focus:border-blue-500"
                value="{{ c.bobot }}" required>
            </td>
            <td class="border border-gray-300 px-2 py-1">
              <select name="criteria_type_{{i}}"
                class="w-full border border-gray-300 rounded px-2 py-1 text-sm sm:text-base focus:ring-blue-500 focus:border-blue-500"
                required>
                <option value="Benefit" {% if c.tipe=='Benefit' %}selected{% endif %}>Benefit</option>
                <option value="Cost" {% if c.tipe=='Cost' %}selected{% endif %}>Cost</option>
              </select>
            </td>
            <td class="border border-gray-300 px-2 py-1 text-center"> 
              <button type="button" class="text-red-600 font-semibold hover:text-red-700 text-sm sm:text-base"
                onclick="removeCriteriaRow(this)">Hapus</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {# END: Responsive Table Wrapper for Criteria #}

    <div class="mb-4 mt-4">
      <p class="font-semibold text-lg text-gray-800">Total Bobot: <span id="totalWeightDisplay"
          class="font-bold"></span></p>
      <p id="totalWeightWarning" class="text-red-600 hidden text-sm mt-1"></p>
    </div>

    <button type="button" onclick="addCriteriaRow()"
      class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition duration-300 ease-in-out shadow-md mr-2">+
      Tambah Kriteria</button>

    <button type="submit" id="submitCriteriaBtn"
      class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out font-semibold mt-4 shadow-md">
      Submit Kriteria
    </button>

    <!-- BUAT DEBUG -->
    <!-- <div id="submittedCriteria" class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200"> {# Added styling for
      summary #}
      <h3 class="text-lg font-bold mb-2 text-gray-800">Daftar Kriteria:</h3>
      <ul class="list-disc pl-5 text-gray-700" id="criteriaSummaryList">
        {% for c in criteria %}
        <li>{{ c.nama }} - Bobot: {{ c.bobot }}, Tipe: {{ c.tipe }}</li>
        {% endfor %}
      </ul>
    </div> -->

  </form>

  <hr class="my-10 border-t border-gray-300"> 

  <form method="post" id="sawForm" class="mb-10 p-4 bg-white rounded-lg shadow-md">
    {% if criteria %}
    <input type="hidden" name="existing_criteria_count" value="{{ criteria|length }}">
    {% for criterion in criteria %}
    <input type="hidden" name="existing_criteria_name_{{ loop.index0 }}" value="{{ criterion.nama }}">
    <input type="hidden" name="existing_criteria_weight_{{ loop.index0 }}" value="{{ criterion.bobot }}">
    <input type="hidden" name="existing_criteria_type_{{ loop.index0 }}" value="{{ criterion.tipe }}">
    {% endfor %}
    {% else %}
    <input type="hidden" name="existing_criteria_count" value="0">
    {% endif %}
    <input type="hidden" name="form_type" value="saw">
    <h2 class="text-xl font-semibold mb-3 text-gray-800">Input Data Alternatif & Hitung SAW</h2>

    {# START: Responsive Table Wrapper for SAW Input #}
    <div class="overflow-x-auto rounded-lg border border-gray-300">
      <table class="min-w-full table-auto border-collapse" id="sawTable">
        <thead>
          <tr class="bg-blue-100">
            <th class="border border-gray-300 px-3 py-2 text-sm sm:text-base">Alternatif</th>
            {% for c in criteria %}
            <th class="border border-gray-300 px-3 py-2 text-sm sm:text-base">{{ c.nama }}<br><small
                class="text-xs sm:text-sm">({{ c.tipe }})</small></th>
            {% endfor %}
            <th class="border border-gray-300 px-3 py-2 text-sm sm:text-base">Aksi</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          {% if criteria and alternatives|length == 0 %}
          <tr>
            <td class="border border-gray-300 px-2 py-1 text-center">
              <input type="text" name="alt_name_0"
                class="w-full text-center border rounded px-1 py-1 text-sm sm:text-base focus:ring-blue-500 focus:border-blue-500"
                placeholder="Nama Mahasiswa" required>
            </td>
            {% for j in range(criteria|length) %}
            {% set p_data = get_placeholder_range(criteria[j].nama) %} 
             <td class="border border-gray-300 px-2 py-1 text-center">
                            <input type="number" name="value_0_{{j}}"
                                class="w-full text-center border rounded px-1 py-1 text-sm sm:text-base focus:ring-blue-500 focus:border-blue-500"
                                placeholder="{{ p_data }}" required
                                {% if criteria[j].nama.lower() == 'ips' %} min="0" max="4" step="0.01"
                                {% elif criteria[j].nama.lower() == 'semester' %} min="1" max="14" step="1"
                                {% elif criteria[j].nama.lower() in ['aktif kemahasiswaan', 'kondisi ekonomi', 'berprestasi', 'motivasi'] %} min="1" max="5" step="1"
                                {% endif %}>
                        </td>
            {% endfor %}
            <td class="border border-gray-300 px-2 py-1 text-center">
              <button type="button"
                class="remove-row text-red-600 font-semibold hover:text-red-700 text-sm sm:text-base">Hapus</button>
            </td>
          </tr>
          {% elif alternatives %}
          {% for i in range(alternatives|length) %}
          <tr>
            <td class="border border-gray-300 px-2 py-1 text-center">
              <input type="text" name="alt_name_{{i}}"
                class="w-full text-center border rounded px-1 py-1 text-sm sm:text-base focus:ring-blue-500 focus:border-blue-500"
                value="{{ alternatives[i] }}" required>
            </td>
            {% for j in range(criteria|length) %}
            {% set attrs = get_placeholder_range(criteria[j].nama) %}
            <td class="border border-gray-300 px-2 py-1 text-center">
              <input type="number" name="value_{{i}}_{{j}}"
                class="w-full text-center border rounded px-1 py-1 text-sm sm:text-base focus:ring-blue-500 focus:border-blue-500"
                value="{{ matrix[i][j] }}" placeholder="{{ attrs.placeholder }}" {{ attrs.min_max_step | safe }}
                required>
            </td>
            {% endfor %}
            <td class="border border-gray-300 px-2 py-1 text-center">
              <button type="button"
                class="remove-row text-red-600 font-semibold hover:text-red-700 text-sm sm:text-base">Hapus</button>
            </td>
          </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="{{ criteria|length + 2 }}"
              class="border border-gray-300 px-2 py-1 text-center text-gray-500 text-sm sm:text-base">
              Isi kriteria terlebih dahulu di atas.
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
    {# END: Responsive Table Wrapper for SAW Input #}

    <button type="button" id="addRowBtn"
      class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700 transition duration-300 ease-in-out shadow-md mr-2">+
      Tambah Alternatif</button>
    <input type="hidden" name="alt_count" id="altCount" value="{{ alternatives|length|default(0) }}"> 
    <button type="submit" id="submitSawBtn"
      class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out font-semibold mt-4 shadow-md">
      Hitung SAW
    </button>
  </form>

  {% if ranked %}
  <section class="mt-10 p-4 bg-white rounded-lg shadow-md"> 
    <h3 class="text-2xl font-bold mb-4 text-gray-800">Ranking Results</h3>
    <div class="overflow-x-auto rounded-lg border border-gray-300">
      <table class="min-w-full table-auto border-collapse">
        <thead>
          <tr class="bg-blue-200">
            <th class="border border-gray-300 px-3 py-2 text-sm sm:text-base">Rank</th>
            <th class="border border-gray-300 px-3 py-2 text-sm sm:text-base">Alternatif</th>
            <th class="border border-gray-300 px-3 py-2 text-sm sm:text-base">Score (V<sub>i</sub>)</th>
          </tr>
        </thead>
        <tbody>
          {% for alt, score in ranked %}
          <tr>
            <td class="border border-gray-300 px-3 py-2 text-center text-sm sm:text-base">{{ loop.index }}</td>
            <td class="border border-gray-300 px-3 py-2 text-sm sm:text-base">{{ alt }}</td>
            <td class="border border-gray-300 px-3 py-2 text-center text-sm sm:text-base">{{ '%.4f'|format(score) }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  {% endif %}

  {% if matrix and normalized_matrix and weighted_matrix and scores %}
  <hr class="my-10 border-t border-gray-300">

  <section class="mt-10 p-4 bg-white rounded-lg shadow-md">
    <h3 class="text-2xl font-bold mb-4 text-gray-800">Langkah-langkah Perhitungan SAW</h3>

    <h4 class="text-xl font-semibold mt-6 mb-2 text-gray-800">1. Matriks Keputusan</h4>
    
    <div class="overflow-x-auto rounded-lg border border-gray-300">
      <table class="min-w-full border">
        <thead class="bg-blue-200 ">
          <tr>
            <th class="border px-2 py-1 text-sm sm:text-base">Alternatif</th>
            {% for c in criteria %}
            <th class="border px-2 py-1 text-sm sm:text-base">{{ c.nama }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for i in range(alternatives|length) %}
          <tr>
            <td class="border px-2 py-1 text-sm sm:text-base">{{ alternatives[i] }}</td>
            {% for j in range(criteria|length) %}
            <td class="border px-2 py-1 text-center text-sm sm:text-base">{{ matrix[i][j] }}</td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    

    <h4 class="text-xl font-semibold mt-6 mb-2 text-gray-800">2. Matriks Ternormalisasi</h4>

    <div class="overflow-x-auto rounded-lg border border-gray-300">
      <table class="min-w-full border">
        <thead class="bg-blue-200 ">
          <tr>
            <th class="border px-2 py-1 text-sm sm:text-base">Alternatif</th>
            {% for c in criteria %}
            <th class="border px-2 py-1 text-sm sm:text-base">{{ c.nama }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for i in range(alternatives|length) %}
          <tr>
            <td class="border px-2 py-1 text-sm sm:text-base">{{ alternatives[i] }}</td>
            {% for j in range(criteria|length) %}
            <td class="border px-2 py-1 text-center text-sm sm:text-base">{{ '%.4f'|format(normalized_matrix[i][j]) }}
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    

    <h4 class="text-xl font-semibold mt-6 mb-2 text-gray-800">3. Normalisasi x Bobot</h4>
    
    <div class="overflow-x-auto rounded-lg border border-gray-300">
      <table class="min-w-full border">
        <thead class="bg-blue-200 ">
          <tr>
            <th class="border px-2 py-1 text-sm sm:text-base">Alternatif</th>
            {% for c in criteria %}
            <th class="border px-2 py-1 text-sm sm:text-base">{{ c.nama }}<br><small class="text-xs sm:text-sm">x {{
                c.bobot }}</small></th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for i in range(alternatives|length) %}
          <tr>
            <td class="border px-2 py-1 text-sm sm:text-base">{{ alternatives[i] }}</td>
            {% for j in range(criteria|length) %}
            <td class="border px-2 py-1 text-center text-sm sm:text-base">{{ '%.4f'|format(weighted_matrix[i][j]) }}
            </td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    

    <h4 class="text-xl font-semibold mt-6 mb-2 text-gray-800">4. Nilai Akhir (V<sub>i</sub>)</h4>
    
    <div class="overflow-x-auto rounded-lg border border-gray-300">
      <table class="min-w-full border">
        <thead class="bg-blue-200 ">
          <tr>
            <th class="border px-2 py-1 text-sm sm:text-base">Alternatif</th>
            <th class="border px-2 py-1 text-sm sm:text-base">Skor Akhir (V<sub>i</sub>)</th>
          </tr>
        </thead>
        <tbody>
          {% for i in range(alternatives|length) %}
          <tr>
            <td class="border px-2 py-1 text-sm sm:text-base">{{ alternatives[i] }}</td>
            <td class="border px-2 py-1 text-center text-sm sm:text-base">{{ '%.4f'|format(scores[i]) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
  </section>
  {% endif %}

</section>

<input type="hidden" id="criteria-count" value="{{ criteria|length|default(0)|int }}">

<!-- modal -->
<div id="instruction-modal" class="w-screen h-screen fixed top-0 left-0 bg-black/50 flex justify-center items-center px-8 hidden">
  

  <div class="rounded-2xl border-2 border-slate-300 bg-white w-full max-h-[500px] mt-[50px] relative flex flex-col justify-center items-center pt-1 pb-6 px-6">
    <div class="w-full flex"><button onclick="toggleDirectionModal()" class="text-5xl ml-auto">Ã—</button></div>

    <h2 class="mt-1 mb-4 font-bold lg:text-3xl">Instruction</h2>

    <div class="w-full grow overflow-scroll">
      <table class=" mt-4 w-full">
        

        
        <tr class="bg-blue-100">
          <th>Criteria</th>
          <th>Type</th>
          <th>Description</th>
        </tr>

        
          {% for c in criteria %}
        <tr>
          <td>{{ c.nama }}</td>
          <td>{{ c.tipe }}</td>
          <td>{{ c.description | safe }}</td>
        </tr>
          {% endfor %}
        

      </table>
    </div>

  </div>
</div>




<script>
  let rowCount; // Akan diinisialisasi dari DOMContentLoaded
  const altCountInput = document.getElementById('altCount');
  const uploadExcelForm = document.getElementById('uploadExcelForm');
  const tableBody = document.getElementById('tableBody');
  const sawForm = document.getElementById('sawForm');
  const submitSawBtn = document.getElementById('submitSawBtn');

  // Tambahkan variabel untuk form kriteria dan tombol submit-nya
  const criteriaForm = document.getElementById('criteriaForm');
  const submitCriteriaBtn = document.getElementById('submitCriteriaBtn');

  // Helper function to get attributes for input number based on criteria name
  function getCriteriaInputAttributes(criteriaName) {
    let attrs = { placeholder: '', min_max_step: 'step="any"' };
    switch (criteriaName.toLowerCase()) {
      case 'ips':
        attrs.placeholder = '0-4';
        attrs.min_max_step = 'min="0" max="4" step="0.01"';
        break;
      case 'semester':
        attrs.placeholder = '1-14';
        attrs.min_max_step = 'min="1" max="14" step="1"';
        break;
      case 'aktif kemahasiswaan':
      case 'kondisi ekonomi':
      // case 'berprestasi':
      case 'motivasi':
        attrs.placeholder = '1-5'; // Assuming a scale of 1-5
        attrs.min_max_step = 'min="1" max="5" step="1"';
        break;
      default:
        attrs.placeholder = 'Enter value';
        attrs.min_max_step = 'min="0" step="any"';
        break;
    }
    return attrs;
  }


  function updateAltCount() {
    const rowElements = tableBody.querySelectorAll('tr');
    const actualRows = Array.from(rowElements).filter(row =>
      row.querySelector('input[name^="alt_name_"]')
    );
    altCountInput.value = actualRows.length;
    rowCount = actualRows.length; 
  }

  document.getElementById('addRowBtn').addEventListener('click', function () {
    const criteriaCountInput = document.querySelector('#sawForm input[name="existing_criteria_count"]');
    const criteriaCount = criteriaCountInput ? parseInt(criteriaCountInput.value) : 0;

    if (isNaN(criteriaCount) || criteriaCount <= 0) {
      Swal.fire({
        title: 'Kriteria Belum Ada!',
        text: 'Harap definisikan kriteria penilaian terlebih dahulu di bagian atas.',
        icon: 'warning',
        confirmButtonColor: '#3085d6',
        confirmButtonText: 'Oke'
      });
      return;
    }

    const criteriaNames = [];
    for (let i = 0; i < criteriaCount; i++) {
      const nameInput = document.querySelector(`#criteriaForm input[name="criteria_name_${i}"]`);
      if (nameInput) {
        criteriaNames.push(nameInput.value);
      }
    }

    const row = document.createElement('tr');
    let rowHTML = `
                <td class="border border-gray-300 px-2 py-1 text-center">
                    <input type="text" name="alt_name_${rowCount}" class="w-full text-center border rounded px-1 py-1 text-sm sm:text-base focus:ring-blue-500 focus:border-blue-500" placeholder="Nama Mahasiswa" required>
                </td>`;
    for (let j = 0; j < criteriaCount; j++) {
      const attrs = getCriteriaInputAttributes(criteriaNames[j] || ''); // Pass criteria name to get attributes
      rowHTML += `
                <td class="border border-gray-300 px-2 py-1 text-center">
                    <input type="number" name="value_${rowCount}_${j}" class="w-full text-center border rounded px-1 py-1 text-sm sm:text-base focus:ring-blue-500 focus:border-blue-500" 
                    placeholder="${attrs.placeholder}" ${attrs.min_max_step} required>
                </td>`;
    }
    rowHTML += `
                <td class="border border-gray-300 px-2 py-1 text-center">
                    <button type="button" class="remove-row text-red-600 font-semibold hover:text-red-700 text-sm sm:text-base">Hapus</button>
                </td>`;

    row.innerHTML = rowHTML;
    tableBody.appendChild(row);
    updateAltCount(); 
  });

  tableBody.addEventListener('click', function (e) {
    if (e.target.classList.contains('remove-row')) {
      const row = e.target.closest('tr');

      Swal.fire({
        title: 'Konfirmasi Hapus Alternatif',
        text: "Apakah Anda yakin ingin menghapus alternatif ini? Tindakan ini tidak bisa dibatalkan.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33', 
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Ya, Hapus!',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          row.remove();
          updateAltCount();
          reindexAlternativesRows(); 
          Swal.fire(
            'Terhapus!',
            'Alternatif berhasil dihapus.',
            'success'
          );
        }
      });
    }
  });

  // Fungsi BARU untuk reindexing baris alternatif setelah penghapusan
  function reindexAlternativesRows() {
    const alternativeRows = tableBody.querySelectorAll('tr');
    alternativeRows.forEach((row, index) => {
      const nameInput = row.querySelector(`input[name^="alt_name_"]`);
      if (nameInput) { 
        nameInput.name = `alt_name_${index}`;
        const valueInputs = row.querySelectorAll(`input[name^="value_"]`);
        valueInputs.forEach((input, colIndex) => {
          input.name = `value_${index}_${colIndex}`;
        });
      }
    });
    updateAltCount(); 
  }

  // --- Kriteria Section JavaScript ---
  function updateCriteriaCountInput() {
    const criteriaRows = document.querySelectorAll('#criteriaList tr');
    document.getElementById('criteriaCountInput').value = criteriaRows.length;
  }


  function addCriteriaRow() {
    const tbody = document.getElementById("criteriaList");
    const currentCriteriaCount = tbody.querySelectorAll('tr').length;

    const row = document.createElement("tr");

    row.innerHTML = `
                <td class="border border-gray-300 px-2 py-1">
                    <input type="text" name="criteria_name_${currentCriteriaCount}" class="w-full border border-gray-300 rounded px-2 py-1 text-sm sm:text-base focus:ring-blue-500 focus:border-blue-500" placeholder="Nama Kriteria" required>
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <input type="number" name="criteria_weight_${currentCriteriaCount}" step="0.01" min="0" max="1" class="w-full border border-gray-300 rounded px-2 py-1 text-sm sm:text-base focus:ring-blue-500 focus:border-blue-500" placeholder="0.00" required>
                </td>
                <td class="border border-gray-300 px-2 py-1">
                    <select name="criteria_type_${currentCriteriaCount}" class="w-full border border-gray-300 rounded px-2 py-1 text-sm sm:text-base focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="Benefit">Benefit</option>
                        <option value="Cost">Cost</option>
                    </select>
                </td>
                <td class="border border-gray-300 px-2 py-1 text-center">
                    <button type="button" class="text-red-600 font-semibold hover:text-red-700 text-sm sm:text-base" onclick="removeCriteriaRow(this)">Hapus</button>
                </td>
        `;

    tbody.appendChild(row);
    updateCriteriaCountInput();
    calculateAndDisplayTotalWeight();
  }


  function removeCriteriaRow(button) {
    const row = button.closest("tr");
    Swal.fire({
      title: 'Konfirmasi Hapus Kriteria',
      text: "Apakah Anda yakin ingin menghapus kriteria ini? Tindakan ini tidak bisa dibatalkan.",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Ya, Hapus!',
      cancelButtonText: 'Batal'
    }).then((result) => {
      if (result.isConfirmed) {
        row.remove();
        updateCriteriaCountInput();
        reindexCriteriaRows();
        calculateAndDisplayTotalWeight();
        submitCriteria(); 
        Swal.fire(
          'Terhapus!',
          'Kriteria berhasil dihapus.',
          'success'
        );
      }
    });
  }

  function reindexCriteriaRows() {
    const criteriaRows = document.querySelectorAll('#criteriaList tr');
    criteriaRows.forEach((row, index) => {
      const nameInput = row.querySelector(`input[name^="criteria_name_"]`);
      const weightInput = row.querySelector(`input[name^="criteria_weight_"]`);
      const typeSelect = row.querySelector(`select[name^="criteria_type_"]`);

      if (nameInput) nameInput.name = `criteria_name_${index}`;
      if (weightInput) weightInput.name = `criteria_weight_${index}`;
      if (typeSelect) typeSelect.name = `criteria_type_${index}`;
    });
  }

  const totalWeightElement = document.getElementById('totalWeightDisplay');
  const totalWeightWarning = document.getElementById('totalWeightWarning');

  function calculateAndDisplayTotalWeight() {
    const criteriaRows = document.querySelectorAll('#criteriaList tr');
    let totalBobot = 0;
    criteriaRows.forEach(row => {
      const weightInput = row.querySelector(`input[name^="criteria_weight_"]`);
      if (weightInput) {
        totalBobot += parseFloat(weightInput.value) || 0;
      }
    });

    if (totalWeightElement) {
      totalWeightElement.textContent = totalBobot.toFixed(2);
    }

    if (totalWeightWarning) {
      if (Math.abs(totalBobot - 1.0) > 0.001) {
        totalWeightWarning.textContent = `Total bobot (${totalBobot.toFixed(2)}) harus sama dengan 1.00!`;
        totalWeightWarning.classList.remove('hidden');
        totalWeightWarning.classList.add('text-red-600');

        Swal.fire({
          title: 'Total Bobot Salah!',
          text: `Total bobot kriteria adalah ${totalWeight.toFixed(2)}. Harap pastikan total bobot sama dengan 1.00 untuk melanjutkan.`,
          icon: 'error',
          confirmButtonColor: '#d33',
          confirmButtonText: 'Oke'
        });
        return;
      } else {
        totalWeightWarning.textContent = '';
        totalWeightWarning.classList.add('hidden');
      }
    }
  }

  document.addEventListener('input', function (event) {
    if (event.target.name && event.target.name.startsWith('criteria_weight_')) {
      calculateAndDisplayTotalWeight();
    }
  });

  document.addEventListener('DOMContentLoaded', function () {
    updateAltCount(); 
    rowCount = parseInt(document.getElementById('altCount').value);
    if (isNaN(rowCount)) {
      rowCount = 0; // Default ke 0 jika tidak ada baris atau NaN
    }

    updateCriteriaCountInput();
    reindexCriteriaRows();
    calculateAndDisplayTotalWeight();
    submitCriteria(); 
  });

  function submitCriteria() {
    const rows = document.querySelectorAll('#criteriaList tr');
    const listContainer = document.getElementById('criteriaSummaryList');
    listContainer.innerHTML = ""; 

    rows.forEach((row, index) => {
      const name = row.querySelector(`input[name^="criteria_name_"]`)?.value;
      const weight = row.querySelector(`input[name^="criteria_weight_"]`)?.value;
      const type = row.querySelector(`select[name^="criteria_type_"]`)?.value;

      if (name && weight && type) {
        const li = document.createElement("li");
        li.textContent = `${name} - Bobot: ${weight}, Tipe: ${type}`;
        listContainer.appendChild(li);
      }
    });
  }

  // SweetAlert for SAW Form Submission
  submitSawBtn.addEventListener('click', function (e) {
    e.preventDefault(); // Prevent default form submission

    // Lakukan validasi HTML5 sebelum menampilkan SweetAlert
    if (!sawForm.checkValidity()) {
      Swal.fire({
        title: 'Peringatan Input!',
        text: 'Harap isi semua kolom alternatif yang diperlukan.',
        icon: 'warning',
        confirmButtonColor: '#3085d6',
        confirmButtonText: 'Oke'
      });
      return;
    }

    Swal.fire({
      title: 'Konfirmasi Perhitungan',
      text: "Apakah Anda yakin ingin menghitung SAW dengan data ini?",
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Ya, Hitung!',
      cancelButtonText: 'Batal'
    }).then((result) => {
      if (result.isConfirmed) {
        sawForm.submit(); // Submit the form if confirmed
      }
    });
  });

  submitCriteriaBtn.addEventListener('click', function (e) {
    e.preventDefault(); 

    const criteriaRows = document.querySelectorAll('#criteriaList tr').length;;

    // Cek apakah tidak ada baris kriteria sama sekali.
    if (criteriaRows.length === 0) {
      Swal.fire({
        title: 'Kriteria Kosong!',
        text: 'Harap tambahkan setidaknya satu kriteria untuk disimpan.',
        icon: 'warning',
        confirmButtonColor: '#3085d6',
        confirmButtonText: 'Oke'
      });
      return;
    }

    if (!criteriaForm.checkValidity()) {
      Swal.fire({
        title: 'Peringatan Input Kriteria!',
        text: 'Harap isi semua kolom kriteria yang diperlukan.',
        icon: 'warning',
        confirmButtonColor: '#3085d6',
        confirmButtonText: 'Oke'
      });
      return;
    }

    // Validasi total bobot
    const totalBobot = parseFloat(totalWeightElement.textContent);
    if (Math.abs(totalBobot - 1.0) > 0.001) { 
      Swal.fire({
        title: 'Bobot Tidak Valid!',
        text: `Total bobot (${totalBobot.toFixed(2)}) harus sama dengan 1.00. Harap sesuaikan.`,
        icon: 'error',
        confirmButtonColor: '#3085d6',
        confirmButtonText: 'Oke'
      });
      return;
    }

    Swal.fire({
      title: 'Konfirmasi Submit Kriteria',
      text: "Apakah Anda yakin ingin menyimpan kriteria ini?",
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Ya, Simpan!',
      cancelButtonText: 'Batal'
    }).then((result) => {
      if (result.isConfirmed) {
        criteriaForm.submit(); 
      }
    });
  });



  uploadExcelForm.addEventListener('submit', async function (e) {
    e.preventDefault(); // Prevent default form submission

    const formData = new FormData(this); // 'this' refers to the form element

    // Get the file input itself
    const fileInput = this.querySelector('input[type="file"]');
    if (fileInput.files.length === 0) {
      Swal.fire({
        title: "Error",
        text: "No file selected.",
        icon: "error"
      });

      return;
    }


    try {
      Swal.fire({
        title: "Continue?",
        showCancelButton: true,
        confirmButtonText: "Continue",
        text: "All data in table will be replaced with your excel file data.",
        icon: "question"
      }).then(async (result) => {

        if (result.isConfirmed) {
          
          const response = await fetch('/read-excel', { // Send to your Flask route
            method: 'POST',
            body: formData, // FormData handles 'multipart/form-data' correctly
          });

          const resultt = await response.json(); // Parse JSON response

          if (response.ok) {
            // console.log(resultt);

            const tbody = document.getElementById('tableBody');
            const criteriaCount = parseInt(document.getElementById('criteria-count').value);


            // empty out entries
            tbody.innerHTML=``;
            rowCount = 0;

            resultt.forEach(alternative => {
              const row = document.createElement('tr');

              let rowHTML = `
                <td class="border border-gray-300 px-2 py-1 text-center">
                  <input type="text" name="alt_name_${rowCount}" class="w-full text-center border rounded px-1 py-1" value="${alternative[0]}">
                </td>`;
              for (let j = 0; j < criteriaCount; j++) {
                rowHTML += `
                <td class="border border-gray-300 px-2 py-1 text-center">
                  <input type="number" step="any" min="0" name="value_${rowCount}_${j}" class="w-full text-center border rounded px-1 py-1" required value="${alternative[j+1]}">
                </td>`;
              }
              rowHTML += `
                <td class="border border-gray-300 px-2 py-1 text-center">
                  <button type="button" class="remove-row text-red-600 font-semibold">Delete</button>
                </td>`;

              row.innerHTML = rowHTML;
              tbody.appendChild(row);
              rowCount++;
              updateAltCount();
            });
              
              

              

          } else {
            
            Swal.fire({
              title: "Error",
              text: "Failed in reading file.",
              icon: "error"
            });
            
          }
        } 
      });
    } catch (error) {
      console.error('Network or parsing error:', error);
      uploadMessageDiv.innerHTML = `<span class="text-red-600">An unexpected client-side error occurred: ${error.message}</span>`;
      if (rowCount === 0) addRow(); // Ensure at least one row exists for manual input
    }
  });

  const instructionModal = document.getElementById('instruction-modal');
  function toggleDirectionModal() {
    document.body.classList.toggle('no-scroll');
    instructionModal.classList.toggle('hidden');
  }

</script>
{% endblock %}